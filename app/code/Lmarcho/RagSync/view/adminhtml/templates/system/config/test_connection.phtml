<?php
/**
 * @var \Lmarcho\RagSync\Block\Adminhtml\System\Config\TestConnection $block
 */
?>
<div class="ragsync-test-connection">
    <?= $block->getButtonHtml() ?>
    <span id="ragsync_test_result" style="margin-left: 10px;"></span>
</div>

<script type="text/javascript">
    require(['jquery', 'Magento_Ui/js/modal/alert'], function($, alert) {
        $('#ragsync_test_connection').click(function() {
            var $button = $(this);
            var $result = $('#ragsync_test_result');

            // Get current form values
            var webhookUrl = $('#rag_sync_connection_webhook_url').val();
            var apiSecretField = $('#rag_sync_connection_api_secret');
            var apiSecret = apiSecretField.val();

            // Check if secret field has actual new value or is unchanged (obscured placeholder)
            // Obscured fields typically have value like "******" or are empty when unchanged
            var isSecretUnchanged = !apiSecret || apiSecret === '' || /^\*+$/.test(apiSecret);

            // Validate URL is entered
            if (!webhookUrl) {
                $result.html('<span style="color: red;">Please enter Webhook Endpoint URL</span>');
                return;
            }

            $button.prop('disabled', true);
            $result.html('<span style="color: #666;">Testing connection...</span>');

            // Build request data
            var requestData = {
                form_key: FORM_KEY,
                webhook_url: webhookUrl
            };

            // Only send api_secret if user entered a new value
            // If unchanged, controller will use saved config value
            if (!isSecretUnchanged) {
                requestData.api_secret = apiSecret;
            }

            $.ajax({
                url: '<?= $block->escapeUrl($block->getAjaxUrl()) ?>',
                type: 'POST',
                dataType: 'json',
                data: requestData,
                success: function(response) {
                    $button.prop('disabled', false);
                    if (response.success) {
                        $result.html('<span style="color: green;">' + response.message + '</span>');
                        if (response.latency) {
                            $result.append(' <small style="color: #666;">(Latency: ' + response.latency + 'ms)</small>');
                        }
                    } else {
                        $result.html('<span style="color: red;">' + response.message + '</span>');
                    }
                },
                error: function(xhr, status, error) {
                    $button.prop('disabled', false);
                    $result.html('<span style="color: red;">Error: ' + error + '</span>');
                }
            });
        });
    });
</script>
