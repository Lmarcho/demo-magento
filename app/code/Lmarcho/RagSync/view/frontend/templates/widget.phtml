<?php
/**
 * Lmarcho RagSync Module - Chat Widget Template
 *
 * @var \Magento\Framework\View\Element\Template $block
 * @var \Lmarcho\RagSync\ViewModel\WidgetConfig $viewModel
 */

$viewModel = $block->getData('view_model');

if (!$viewModel->shouldDisplay()) {
    return;
}

$scriptUrl = $viewModel->getScriptUrl();
if (empty($scriptUrl)) {
    return;
}

$configUrl = $viewModel->getConfigUrl();
$apiBaseUrl = $viewModel->getApiBaseUrl();
$apiKey = $viewModel->getApiKey();
$customerContext = $viewModel->getCustomerContextJson();
$chatSession = $viewModel->getChatSessionJson();
?>
<script>
(function() {
    'use strict';

    var scriptUrl = <?= /* @noEscape */ json_encode($scriptUrl) ?>;
    var configUrl = <?= /* @noEscape */ json_encode($configUrl) ?>;
    var apiBaseUrl = <?= /* @noEscape */ json_encode($apiBaseUrl) ?>;
    var apiKey = <?= /* @noEscape */ json_encode($apiKey) ?>;
    var customerContext = <?= /* @noEscape */ $customerContext ?>;
    var chatSession = <?= /* @noEscape */ $chatSession ?>;

    // Load the widget script
    var script = document.createElement('script');
    script.src = scriptUrl + '?v=' + Date.now();
    script.async = true;
    script.onload = function() {
        if (typeof window.RAGWidget === 'undefined') {
            console.error('RAG Widget: RAGWidget not found after script load');
            return;
        }

        // Fetch config from Laravel backend
        fetch(configUrl)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Config fetch failed: ' + response.status);
                }
                return response.json();
            })
            .then(function(config) {
                // Initialize widget with config from backend + Magento context
                window.RAGWidget.init({
                    ...config,
                    apiUrl: apiBaseUrl,
                    apiKey: apiKey,
                    customer: customerContext,
                    session: chatSession,
                    debug: false
                });
            })
            .catch(function(error) {
                console.error('RAG Widget: Failed to initialize', error);
            });
    };
    script.onerror = function() {
        console.error('RAG Widget: Failed to load widget script');
    };
    document.head.appendChild(script);
})();
</script>
